name: ğŸ“¦ Build and Release
on:
  schedule:
    - cron: '* */1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: "è·³è¿‡ commit æ£€æŸ¥å¼ºåˆ¶æ„å»º"
        required: false
        default: "true"
jobs:
  build:
    runs-on: ubuntu-latest
    env:  # å…¨å±€ç¯å¢ƒå˜é‡
      SOURCE_REPO: "FongMi/media"
      SOURCE_BRANCH: "1.8.0-fongmi"
      SOURCE_DIR: ${{ github.workspace }}/_source
      LIB_DIR: ${{ github.workspace }}/_source/libraries  # ä½¿ç”¨ GitHub é¢„å®šä¹‰çš„å·¥ä½œç›®å½•
      TARGET_DIR: ${{ github.workspace }}/_source/target
      MOVE_LIST: ${{ github.workspace }}/_source/move.txt
      HASH_FILE: ${{ github.workspace }}/_source/target/hash.txt
      FORCE_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: ğŸ” Fetch latest commit from FongMi/media
        id: fetch-commit
        run: |
          if [ "$FORCE_BUILD" = "true" ]; then
           echo "::notice::æ‰‹åŠ¨è§¦å‘å¼ºåˆ¶æ„å»ºï¼Œè·³è¿‡ commit æ£€æŸ¥"
            echo "should_build=true" >> $GITHUB_OUTPUT
           exit 0
          fi
          LATEST_COMMIT=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$SOURCE_REPO/commits/$SOURCE_BRANCH" | jq -r '.sha')
          echo "Latest commit: $LATEST_COMMIT"
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          if [ -f .last_known_commit ]; then
            LAST_KNOWN=$(cat .last_known_commit)
            echo "Last known commit: $LAST_KNOWN"
          else
            LAST_KNOWN=""
            echo "No previous commit record found"
          fi
          
          if [ "$LATEST_COMMIT" != "$LAST_KNOWN" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
           echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      - name: â© Skip build if no changes
        if: steps.check-build.outputs.should_build == 'false'
        run: echo "ğŸ”„ No new commits, skipping build."
      - name: ğŸ› ï¸ Clone FongMi/media
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          git clone --depth 1 --branch $SOURCE_BRANCH \
          https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/$SOURCE_REPO.git $SOURCE_DIR
      - name: ğŸ’¾ Persist new commit hash
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ›‘ æ‰‹åŠ¨æ‰§è¡Œæ¨¡å¼ï¼šè·³è¿‡ .last_known_commit æ›´æ–°"
            exit 0
          fi
          mkdir -p $(dirname .last_known_commit)
           if [ ! -f .last_known_commit ] || 
              [ "$(cat .last_known_commit)" != "${{ steps.fetch-commit.outputs.commit }}" ]; then
              echo "${{ steps.fetch-commit.outputs.commit }}" > .last_known_commit
              git config --global user.name "github-actions[bot]"
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              if ! grep -q "_source/" .gitignore; then
                echo "_source/" >> .gitignore
                git add .gitignore
                git commit -m "Add _source to gitignore [skip ci]"
              fi
              git fetch origin
              git merge --no-edit origin/${{ github.ref_name }}
              git add .last_known_commit
              git commit -m "Update tracked commit to ${{ steps.fetch-commit.outputs.commit }} [skip ci]"
              for i in {1..3}; do git push origin ${{ github.ref }} && break || sleep 5; done
           else
              echo "âœ… .last_known_commit å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
           fi
      - name: â˜• Set up JDK 17
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
      - name: ğŸ”¨ Build AAR
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          cd $SOURCE_DIR
          ./gradlew assembleRelease
          mkdir -p "$TARGET_DIR"
          echo "ğŸ” Source dir: $LIB_DIR"
          echo "ğŸ¯ Target dir: $TARGET_DIR"
          echo "ğŸ“‹ Move list: $MOVE_LIST"
          echo "# ğŸ“ MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> "$HASH_FILE"
          echo "" >> "$HASH_FILE"
          find "$LIB_DIR" -name "lib-*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            if grep -qFx "$filename" "$MOVE_LIST"; then
              cp -v "$aar_file" "$TARGET_DIR/"
              md5sum "$aar_file" | awk -v filename=$(basename "$aar_file") '{print filename " " $1}' >> "$HASH_FILE"
              echo "âœ… Copied: $filename"
            else
              echo "â© Skipped: $filename"
            fi
          done
          echo ""
          echo "ğŸ“¦ Generated AAR files:"
          ls -lh "$TARGET_DIR"
          echo ""
          echo "ğŸ” MD5 Checksums:"
          cat "$HASH_FILE"
      - name: ğŸ“¤ Upload artifacts
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lib-aars
          path: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
      - name: â±ï¸ Generate current time
        if: steps.fetch-commit.outputs.should_build == 'true'
        id: datetime
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
      - name: ğŸ—œï¸ Upload to Release
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v1.8.0-fongmi"
          name: "ğŸ“± Media3 Release"
          body: |
            âœ¨ **Media3 fongmi AAR Build** âœ¨
            
            ### ğŸ“¦ Release Info
            - ğŸ·ï¸ Version: v1.8.0-fongmi
            - ğŸ“… Build Date: ${{ steps.datetime.outputs.CURRENT_TIME }}
            - ğŸ” Checksum: [hash.txt](https://github.com/${{ github.repository }}/releases/download/v1.8.0-fongmi/hash.txt)
          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
          token: ${{ secrets.GITHUB_TOKEN }}