name: üì¶ Build and Release
on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: "Ë∑≥Ëøá commit Ê£ÄÊü•Âº∫Âà∂ÊûÑÂª∫"
        required: false
        default: "true"

jobs:
  build:
    runs-on: ubuntu-latest
    env:  # Áªü‰∏ÄÁÆ°ÁêÜÊâÄÊúâÂèòÈáè
      SOURCE_REPO: "FongMi/media"
      SOURCE_BRANCH: "release-1.9.2-fongmi"
      APP_VERSION: "release-1.9.2-fongmi" # ÊèêÂèñÁöÑÁâàÊú¨Âè∑ÂèòÈáè
      SOURCE_DIR: ${{ github.workspace }}/_source
      LIB_DIR: ${{ github.workspace }}/_source/libraries
      TARGET_DIR: ${{ github.workspace }}/_source/target
      HASH_FILE: ${{ github.workspace }}/_source/target/hash.txt
      AAR_LIST_FILE: ${{ github.workspace }}/aar_list.txt
      FORCE_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}

    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üîç Fetch latest commit
        id: fetch-commit
        run: |
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          LATEST_COMMIT=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$SOURCE_REPO/commits/$SOURCE_BRANCH" | jq -r '.sha')
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          LAST_KNOWN=$(cat .last_known_commit 2>/dev/null || echo "")
          [ "$LATEST_COMMIT" != "$LAST_KNOWN" ] && echo "should_build=true" >> $GITHUB_OUTPUT || echo "should_build=false" >> $GITHUB_OUTPUT

      - name: üõ†Ô∏è Clone FongMi/media
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: git clone --depth 1 --branch $SOURCE_BRANCH https://github.com/$SOURCE_REPO.git $SOURCE_DIR

      - name: üíæ Persist new commit hash
        if: steps.fetch-commit.outputs.should_build == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          echo "${{ steps.fetch-commit.outputs.commit }}" > .last_known_commit
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_known_commit
          git commit -m "Update tracked commit [skip ci]" || exit 0
          git push origin HEAD:${{ github.ref_name }}

      - name: ‚òï Set up JDK 17
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
          server-id: github

      - name: üî® Build and Collect AARs
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          cd $SOURCE_DIR
          ./gradlew assembleRelease
          mkdir -p "$TARGET_DIR"
          
          echo "# üìù MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> "$HASH_FILE"
          
          touch "$AAR_LIST_FILE"
          find "$LIB_DIR" -name "lib-*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            cp "$aar_file" "$TARGET_DIR/"
            md5sum "$aar_file" | awk '{print $1}' | xargs -I {} echo "$filename {}" >> "$HASH_FILE"
            echo "$filename" >> "$AAR_LIST_FILE"
          done

      - name: üì¶ Publish All AARs
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          # Âä®ÊÄÅÈÖçÁΩÆ Maven ËÆ§ËØÅ
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

          while IFS= read -r artifact || [ -n "$artifact" ]; do
            [ -z "$artifact" ] && continue
            ARTIFACT_ID=$(echo "$artifact" | sed 's/-release\.aar$//')
            echo "üì§ Deploying $ARTIFACT_ID version $APP_VERSION"
          
            mvn deploy:deploy-file \
              -Dfile="$TARGET_DIR/$artifact" \
              -DgroupId=com.fongmi.media3 \
              -DartifactId=$ARTIFACT_ID \
              -Dversion=$APP_VERSION \
              -Dpackaging=aar \
              -DrepositoryId=github \
              -Durl=https://maven.pkg.github.com/${{ github.repository }}
          done < "$AAR_LIST_FILE"

      - name: üóúÔ∏è Create Release
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.APP_VERSION }}" # Ëá™Âä®Âä†‰∏ä 'v' ÂâçÁºÄ
          name: "üì± Media3 Release (${{ env.APP_VERSION }})"
          body: |
            ‚ú® **Media3 FongMi AAR Ëá™Âä®ÊûÑÂª∫** ‚ú®
            - üè∑Ô∏è ÁâàÊú¨: `${{ env.APP_VERSION }}`
            - üîó Ê∫êÁ†ÅÂàÜÊîØ: `${{ env.SOURCE_BRANCH }}`
            - üìÖ ÊûÑÂª∫Êó∂Èó¥: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}