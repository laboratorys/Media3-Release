name: ğŸ“¦ Build and Release
on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
    inputs:
      source_branch:
        description: "1. æºç åˆ†æ”¯ (Source Branch)"
        required: false
        default: "release-1.9.2-fongmi"
      maven_version:
        description: "2. Maven ä¾èµ–ç‰ˆæœ¬ (e.g. 1.9.2)"
        required: false
        default: "1.9.2"
      app_version:
        description: "3. Release æ ‡ç­¾ç‰ˆæœ¬ (e.g. 1.9.2-fongmi)"
        required: false
        default: "1.9.2-fongmi"
      force:
        description: "è·³è¿‡ commit æ£€æŸ¥å¼ºåˆ¶æ„å»º"
        required: false
        default: "true"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SOURCE_REPO: "FongMi/media"
      # ä¼˜å…ˆçº§ï¼šæ‰‹åŠ¨è¾“å…¥ > é»˜è®¤å€¼
      SOURCE_BRANCH: ${{ github.event.inputs.source_branch || 'release-1.9.2-fongmi' }}
      MAVEN_VERSION: ${{ github.event.inputs.maven_version || '1.9.2' }}
      APP_VERSION: ${{ github.event.inputs.app_version || '1.9.2-fongmi' }}

      SOURCE_DIR: ${{ github.workspace }}/_source
      LIB_DIR: ${{ github.workspace }}/_source/libraries
      TARGET_DIR: ${{ github.workspace }}/_source/target
      HASH_FILE: ${{ github.workspace }}/_source/target/hash.txt
      AAR_LIST_FILE: ${{ github.workspace }}/aar_list.txt
      FORCE_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ” Fetch latest commit
        id: fetch-commit
        run: |
          LATEST_COMMIT=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$SOURCE_REPO/commits/$SOURCE_BRANCH" | jq -r '.sha')
          
          if [ "$LATEST_COMMIT" == "null" ] || [ -z "$LATEST_COMMIT" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°åˆ†æ”¯ $SOURCE_BRANCH æˆ– API è¯·æ±‚å¤±è´¥"
            exit 1
          fi
          
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            LAST_KNOWN=$(cat .last_known_commit 2>/dev/null || echo "")
            [ "$LATEST_COMMIT" != "$LAST_KNOWN" ] && echo "should_build=true" >> $GITHUB_OUTPUT || echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ› ï¸ Clone Source
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: git clone --depth 1 --branch $SOURCE_BRANCH https://github.com/$SOURCE_REPO.git $SOURCE_DIR

      - name: â˜• Set up JDK 17
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ”¨ Build and Collect AARs
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          cd $SOURCE_DIR
          chmod +x ./gradlew
          ./gradlew assembleRelease
          
          mkdir -p "$TARGET_DIR"
          SH_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          echo "BUILD_TIME=$SH_TIME" >> $GITHUB_ENV
          
          echo "# ğŸ“ MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $SH_TIME" >> "$HASH_FILE"
          
          > "$AAR_LIST_FILE"
          find "$LIB_DIR" -name "*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            cp "$aar_file" "$TARGET_DIR/"
            md5=$(md5sum "$aar_file" | awk '{print $1}')
            echo "$filename $md5" >> "$HASH_FILE"
            echo "$filename" >> "$AAR_LIST_FILE"
          done

      - name: ğŸš€ Push to Maven Branch
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          DEPLOY_PATH="$GITHUB_WORKSPACE/repo-deploy"
          git clone --depth 1 --branch maven https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} $DEPLOY_PATH || {
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH
            git init -b maven
            git remote add origin https://github.com/${{ github.repository }}
          }
          
          cd $DEPLOY_PATH
          while IFS= read -r artifact; do
            [ -z "$artifact" ] && continue
            ARTIFACT_ID=$(echo "$artifact" | sed 's/-release\.aar$//; s/\.aar$//')
          
            mvn install:install-file \
              -Dfile="$TARGET_DIR/$artifact" \
              -DgroupId=androidx.media3 \
              -DartifactId=$ARTIFACT_ID \
              -Dversion=$MAVEN_VERSION \
              -Dpackaging=aar \
              -DgeneratePom=true \
              -DlocalRepositoryPath=$DEPLOY_PATH
          done < "$AAR_LIST_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy version $MAVEN_VERSION (Branch: $SOURCE_BRANCH)" || exit 0
          git push origin maven

      - name: ğŸ’¾ Update Last Commit Info
        # åªæœ‰åœ¨ schedule è‡ªåŠ¨è¿è¡Œä¸”æ„å»ºæˆåŠŸæ—¶ï¼Œæ‰æ›´æ–° commit è¿½è¸ªæ–‡ä»¶
        if: steps.fetch-commit.outputs.should_build == 'true' && github.event_name == 'schedule'
        run: |
          echo "${{ steps.fetch-commit.outputs.commit }}" > .last_known_commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_known_commit
          git commit -m "Update tracked commit [skip ci]" || exit 0
          git push origin HEAD:${{ github.ref_name }}

      - name: ğŸ—œï¸ Create Release
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.APP_VERSION }}"
          name: "Release v${{ env.APP_VERSION }}"
          prerelease: true
          body: |
            âœ¨ **Media3 FongMi AAR è‡ªåŠ¨æ„å»º** âœ¨
            - ğŸŒ¿ æºç åˆ†æ”¯: `${{ env.SOURCE_BRANCH }}`
            - ğŸ“¦ Maven ç‰ˆæœ¬: `${{ env.MAVEN_VERSION }}`
            - ğŸ·ï¸ Release ç‰ˆæœ¬: `${{ env.APP_VERSION }}`
            - ğŸ”— æºç  commit: `${{ steps.fetch-commit.outputs.commit }}`
            - ğŸ“… æ„å»ºæ—¶é—´: `${{ env.BUILD_TIME }}`
          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}