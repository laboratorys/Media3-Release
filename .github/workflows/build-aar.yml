name: ğŸ“¦ Build and Release
on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: "è·³è¿‡ commit æ£€æŸ¥å¼ºåˆ¶æ„å»º"
        required: false
        default: "true"

jobs:
  build:
    runs-on: ubuntu-latest
    env:  # ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å˜é‡
      SOURCE_REPO: "FongMi/media"
      SOURCE_BRANCH: "release-1.9.2-fongmi"
      APP_VERSION: "1.9.2-fongmi"
      MAVEN_VERSION: "1.9.2"
      SOURCE_DIR: ${{ github.workspace }}/_source
      LIB_DIR: ${{ github.workspace }}/_source/libraries
      TARGET_DIR: ${{ github.workspace }}/_source/target
      HASH_FILE: ${{ github.workspace }}/_source/target/hash.txt
      AAR_LIST_FILE: ${{ github.workspace }}/aar_list.txt
      FORCE_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ” Fetch latest commit
        id: fetch-commit
        run: |
          if [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          LATEST_COMMIT=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$SOURCE_REPO/commits/$SOURCE_BRANCH" | jq -r '.sha')
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          LAST_KNOWN=$(cat .last_known_commit 2>/dev/null || echo "")
          [ "$LATEST_COMMIT" != "$LAST_KNOWN" ] && echo "should_build=true" >> $GITHUB_OUTPUT || echo "should_build=false" >> $GITHUB_OUTPUT

      - name: ğŸ› ï¸ Clone FongMi/media
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: git clone --depth 1 --branch $SOURCE_BRANCH https://github.com/$SOURCE_REPO.git $SOURCE_DIR

      - name: ğŸ’¾ Persist new commit hash
        if: steps.fetch-commit.outputs.should_build == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          echo "${{ steps.fetch-commit.outputs.commit }}" > .last_known_commit
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_known_commit
          git commit -m "Update tracked commit [skip ci]" || exit 0
          git push origin HEAD:${{ github.ref_name }}

      - name: â˜• Set up JDK 17
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
          server-id: github

      - name: ğŸ”¨ Build and Collect AARs
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          cd $SOURCE_DIR
          ./gradlew assembleRelease
          mkdir -p "$TARGET_DIR"
          SH_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          echo "BUILD_TIME=$SH_TIME" >> $GITHUB_ENV
          echo "# ğŸ“ MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> "$HASH_FILE"
          
          touch "$AAR_LIST_FILE"
          find "$LIB_DIR" -name "lib-*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            cp "$aar_file" "$TARGET_DIR/"
            md5sum "$aar_file" | awk '{print $1}' | xargs -I {} echo "$filename {}" >> "$HASH_FILE"
            echo "$filename" >> "$AAR_LIST_FILE"
          done

      - name: ğŸš€ Push to Maven Branch
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          mkdir -p $GITHUB_WORKSPACE/repo-deploy
          cd $GITHUB_WORKSPACE/repo-deploy
          
          # å…‹éš†ç°æœ‰åˆ†æ”¯ä»¥ä¿ç•™å†å²ç‰ˆæœ¬
          git clone --depth 1 --branch maven https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} . || git init -b maven
          
          while IFS= read -r artifact || [ -n "$artifact" ]; do
            [ -z "$artifact" ] && continue
            ARTIFACT_ID=$(echo "$artifact" | sed 's/-release\.aar$//')
          
            mvn install:install-file \
              -Dfile="$TARGET_DIR/$artifact" \
              -DgroupId=com.fongmi.media3 \
              -DartifactId=$ARTIFACT_ID \
              -Dversion=$MAVEN_VERSION \
              -Dpackaging=aar \
              -DlocalRepositoryPath=$(pwd)
          done < "$AAR_LIST_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add version $MAVEN_VERSION to maven repo"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} maven

      - name: ğŸ—œï¸ Create Release
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.APP_VERSION }}" # è‡ªåŠ¨åŠ ä¸Š 'v' å‰ç¼€
          name: "ğŸ“± Media3 Release (${{ env.APP_VERSION }})"
          body: |
            âœ¨ **Media3 FongMi AAR è‡ªåŠ¨æ„å»º** âœ¨
            - ğŸ·ï¸ ç‰ˆæœ¬: `${{ env.APP_VERSION }}`
            - ğŸ”— æºç åˆ†æ”¯: `${{ env.SOURCE_BRANCH }}`
            - ğŸ“… æ„å»ºæ—¶é—´: `${{ env.BUILD_TIME }}`
          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}