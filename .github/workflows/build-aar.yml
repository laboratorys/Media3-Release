name: ğŸ“¦ Build and Release
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
jobs:
  build:
    runs-on: ubuntu-latest
    env:  # å…¨å±€ç¯å¢ƒå˜é‡
      SOURCE_DIR: ${{ github.workspace }}/libraries  # ä½¿ç”¨ GitHub é¢„å®šä¹‰çš„å·¥ä½œç›®å½•
      TARGET_DIR: ${{ github.workspace }}/target
      MOVE_LIST: ${{ github.workspace }}/move.txt
      HASH_FILE: ${{ github.workspace }}/target/hash.txt
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v5
        with:
          repository: FongMi/media
          ref: 1.8.0-fongmi
          fetch-depth: 0
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
      - name: ğŸ”¨ Build AAR
        run: |
          ./gradlew assembleRelease
          mkdir -p "$TARGET_DIR"
          echo "ğŸ” Source dir: $SOURCE_DIR"
          echo "ğŸ¯ Target dir: $TARGET_DIR"
          echo "ğŸ“‹ Move list: $MOVE_LIST"
          echo "# ğŸ“ MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$HASH_FILE"
          echo "" >> "$HASH_FILE"
          find "$SOURCE_DIR" -name "lib-*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            if grep -qFx "$filename" "$MOVE_LIST"; then
              cp -v "$aar_file" "$TARGET_DIR/"
              md5sum "$aar_file" | awk '{print $2 " " $1}' >> "$HASH_FILE"
              echo "âœ… Copied: $filename"
            else
              echo "â© Skipped: $filename"
            fi
          done
          echo ""
          echo "ğŸ“¦ Generated AAR files:"
          ls -lh "$TARGET_DIR"
          echo ""
          echo "ğŸ” MD5 Checksums:"
          cat "$HASH_FILE"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lib-aars
          path: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
      - name: â±ï¸ Generate current time
        id: datetime
        run: |
          echo "CURRENT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "BUILD_INFO=$(echo -e "ğŸ› ï¸ Built with GitHub Actions\nâ° Build Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸŒ Runner: ${{ runner.os }}")" >> $GITHUB_OUTPUT
      - name: ğŸš€ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v1.8.0-fongmi"
          name: "ğŸ“± Media3 Release v1.8.0-fongmi"
          body: |
            âœ¨ **Media3 fongmi AAR Build** âœ¨
            
            ### ğŸ“¦ Release Info
            - ğŸ·ï¸ Version: v1.8.0-fongmi
            - ğŸ“… Build Date: ${{ steps.datetime.outputs.CURRENT_TIME }}
            - ğŸ” Checksum: [hash.txt](https://github.com/${{ github.repository }}/releases/download/v1.8.0-fongmi/hash.txt)
            
            ### ğŸ“ MD5 Checksums
            ```
            $(cat ${{ env.HASH_FILE }} | grep -v "#")
            ```
            
            ### ğŸ› ï¸ Build Details
            ${{ steps.datetime.outputs.BUILD_INFO }}
            
            ### ğŸ“š Included AARs
            $(ls -1 ${{ env.TARGET_DIR }}/*.aar | xargs -n1 basename | awk '{print "- " $0}')

          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
          token: ${{ secrets.GITHUB_TOKEN }}