name: üì¶ Build and Release
on:
  schedule:
    - cron: '* */1 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: "Ë∑≥Ëøá commit Ê£ÄÊü•Âº∫Âà∂ÊûÑÂª∫"
        required: false
        default: "true"
jobs:
  build:
    runs-on: ubuntu-latest
    env:  # ÂÖ®Â±ÄÁéØÂ¢ÉÂèòÈáè
      SOURCE_REPO: "FongMi/media"
      SOURCE_BRANCH: "release-1.9.2-fongmi"
      SOURCE_DIR: ${{ github.workspace }}/_source
      LIB_DIR: ${{ github.workspace }}/_source/libraries  # ‰ΩøÁî® GitHub È¢ÑÂÆö‰πâÁöÑÂ∑•‰ΩúÁõÆÂΩï
      TARGET_DIR: ${{ github.workspace }}/_source/target
      HASH_FILE: ${{ github.workspace }}/_source/target/hash.txt
      FORCE_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' }}
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: üîç Fetch latest commit from FongMi/media
        id: fetch-commit
        run: |
          if [ "$FORCE_BUILD" = "true" ]; then
           echo "::notice::ÊâãÂä®Ëß¶ÂèëÂº∫Âà∂ÊûÑÂª∫ÔºåË∑≥Ëøá commit Ê£ÄÊü•"
            echo "should_build=true" >> $GITHUB_OUTPUT
           exit 0
          fi
          LATEST_COMMIT=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$SOURCE_REPO/commits/$SOURCE_BRANCH" | jq -r '.sha')
          echo "Latest commit: $LATEST_COMMIT"
          echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          if [ -f .last_known_commit ]; then
            LAST_KNOWN=$(cat .last_known_commit)
            echo "Last known commit: $LAST_KNOWN"
          else
            LAST_KNOWN=""
            echo "No previous commit record found"
          fi
          
          if [ "$LATEST_COMMIT" != "$LAST_KNOWN" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
           echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      - name: ‚è© Skip build if no changes
        if: steps.check-build.outputs.should_build == 'false'
        run: echo "üîÑ No new commits, skipping build."
      - name: üõ†Ô∏è Clone FongMi/media
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          git clone --depth 1 --branch $SOURCE_BRANCH \
          https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/$SOURCE_REPO.git $SOURCE_DIR
      - name: üíæ Persist new commit hash
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üõë ÊâãÂä®ÊâßË°åÊ®°ÂºèÔºöË∑≥Ëøá .last_known_commit Êõ¥Êñ∞"
            exit 0
          fi
          mkdir -p $(dirname .last_known_commit)
           if [ ! -f .last_known_commit ] || 
              [ "$(cat .last_known_commit)" != "${{ steps.fetch-commit.outputs.commit }}" ]; then
              echo "${{ steps.fetch-commit.outputs.commit }}" > .last_known_commit
              git config --global user.name "github-actions[bot]"
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              if ! grep -q "_source/" .gitignore; then
                echo "_source/" >> .gitignore
                git add .gitignore
                git commit -m "Add _source to gitignore [skip ci]"
              fi
              git fetch origin
              git merge --no-edit origin/${{ github.ref_name }}
              git add .last_known_commit
              git commit -m "Update tracked commit to ${{ steps.fetch-commit.outputs.commit }} [skip ci]"
              for i in {1..3}; do git push origin ${{ github.ref }} && break || sleep 5; done
           else
              echo "‚úÖ .last_known_commit Â∑≤ÊòØÊúÄÊñ∞ÔºåÊó†ÈúÄÊõ¥Êñ∞"
           fi
      - name: ‚òï Set up JDK 17
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
      - name: üî® Build AAR
        if: steps.fetch-commit.outputs.should_build == 'true'
        run: |
          cd $SOURCE_DIR
          ./gradlew assembleRelease
          mkdir -p "$TARGET_DIR"
          echo "üîç Source dir: $LIB_DIR"
          echo "üéØ Target dir: $TARGET_DIR"
          echo "# üìù MD5 Checksums" > "$HASH_FILE"
          echo "# Generated at $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')" >> "$HASH_FILE"
          echo "" >> "$HASH_FILE"
          AAR_LIST_TMP="${{ github.workspace }}/aar_list.txt"
          touch "$AAR_LIST_TMP"
          find "$LIB_DIR" -name "lib-*-release.aar" | while read -r aar_file; do
            filename=$(basename "$aar_file")
            cp -v "$aar_file" "$TARGET_DIR/"
            md5sum "$aar_file" | awk -v filename=$(basename "$aar_file") '{print filename " " $1}' >> "$HASH_FILE"
            echo "$filename" >> "$AAR_LIST_TMP"
            echo "‚úÖ Copied: $filename"
          done
          echo ""
          echo "üì¶ Generated AAR files:"
          ls -lh "$TARGET_DIR"
          echo ""
          echo "üîè MD5 Checksums:"
          cat "$HASH_FILE"
      - name: üì§ Upload artifacts
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lib-aars
          path: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
      - name: ‚è±Ô∏è Generate current time
        if: steps.fetch-commit.outputs.should_build == 'true'
        id: datetime
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_OUTPUT
      - name: üì¶ Publish All AARs to GitHub Packages
        if: steps.fetch-commit.outputs.should_build == 'true'
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GROUP_ID: com.fongmi.media3
          VERSION: release-1.9.2-fongmi
          REPO_URL: https://maven.pkg.github.com/${{ github.repository }}
        run: |
          sudo apt-get update && sudo apt-get install -y maven

          while IFS= read -r artifact; do
            [ -z "$artifact" ] && continue
            echo "‚û°Ô∏è Processing AAR: $artifact"

            AAR_PATH="$TARGET_DIR/$artifact"
            if [ ! -f "$AAR_PATH" ]; then
              echo "‚ö†Ô∏è File not found: $AAR_PATH"
              continue
            fi

            # ÊèêÂèñ artifactIdÔºàÂéªÊéâÂêéÁºÄ -release.aar ‚Üí lib-coreÔºâ
            ARTIFACT_ID=$(echo "$artifact" | sed 's/-release\.aar$//')
            echo "üì§ Deploying $GROUP_ID:$ARTIFACT_ID:$VERSION"

            mvn deploy:deploy-file \
              -Dfile="$AAR_PATH" \
              -DgroupId=$GROUP_ID \
              -DartifactId=$ARTIFACT_ID \
              -Dversion=$VERSION \
              -Dpackaging=aar \
              -DrepositoryId=github \
              -Durl=$REPO_URL \
              -DretryFailedDeploymentCount=3 || {
                echo "‚ùå Failed to upload $artifact"
                exit 1
              }
          done < "${{ github.workspace }}/aar_list.txt"
      - name: üóúÔ∏è Upload to Release
        if: steps.fetch-commit.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v1.9.2-fongmi"
          name: "üì± Media3 Release"
          body: |
            ‚ú® **Media3 fongmi AAR Build** ‚ú®
            
            ### üì¶ Release Info
            - üè∑Ô∏è Version: v1.9.2-fongmi
            - üìÖ Build Date: ${{ steps.datetime.outputs.CURRENT_TIME }}
            - üîê Checksum: [hash.txt](https://github.com/${{ github.repository }}/releases/download/v1.9.2-fongmi/hash.txt)
          files: |
            ${{ env.TARGET_DIR }}/*.aar
            ${{ env.HASH_FILE }}
          token: ${{ secrets.GITHUB_TOKEN }}